# 浮点数的表示与运算

IEEE 754 binary 格式中，浮点数按照 **科学计数法** 进行编码

$$
\text{Value} = (-1)^\text{Sign} \times \text{Fraction} \times 2^ \text{Exponent}
$$


IEEE 754 binary 编码的位模式在计算机的布局如下图

![Pasted image 20240923162144|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755701532020-06a81b552d2a413088f1299fbf61fb28.png)

+ 指数位(`Exponent`) 采用 **移码** 表示
+ 尾数位(`Fraction`) 位采用 **无符号** 表示(规格化的) 

> [!tip] 二进制下的规格化数的整数位部分一定是 $1$ 

> [!important] 移码
> 
> [移码](https://en.wikipedia.org/wiki/Offset_binary) 也称 **偏置二进制** 编码，是一种 [有符号数字表示](https://en.wikipedia.org/wiki/Signed_number_representation "Signed number representation") 方法，其中有符号数字 $n$ 由对应于无符号数 $n+K$ 的位模式表示，$K$ 是 _偏置值_ 或 _偏移量_
> 
> 偏置二进制编码没有标准：在大多数情况下，$n$ 位偏置二进制编码的 偏置值 $K$ 为 $K=2^{n-1}$
> 
> IEEE 754 标准中，指数部分采用的偏置值是 $2^{n-1}-1$


## 单精度浮点数(binary32)

> [!tip] 符号位宽： $1$ 位
> + `0` 表示正数
> + `1` 表示负数

> [!tip] 指数位宽：$8$ 位，采用 **移码** 系统表示
> + 偏置为 $2^{7}-1 = 127$
> + 表示指数的范围位 $[-126, 127]$
> + **指数部分全为 $0$**，即 $-127$ 和 **指数部分全为 $1$**，即 $128$ 有特殊用途

> [!tip] 尾数位宽：$23$ 位
> + 隐含表示首位的 $1$：即，尾数提供了 $24$ 位的精度，但是显示存储 $23$ 位

## 双精度浮点数(binary64)

> [!tip] 符号位宽： $1$ 位
> + `0` 表示正数
> + `1` 表示负数

> [!tip] 指数位宽：$11$ 位，采用 **移码** 系统表示
> + 偏置为 $2^{10}-1 = 1023$
> + 表示指数的范围位 $[-1022, 1023]$
> + **指数部分全为 $0$**，即 $-1023$ 和 **指数部分全为 $1$**，即 $1024$ 有特殊用途

> [!tip] 尾数位宽：$52$ 位
> + 隐含表示首位的 $1$：即，尾数提供了 $53$ 位的精度，但是显示存储 $52$ 位

## 特殊值

> [!tip] IEEE 754 binary 格式的 $\pm 0$
>  
>  指数位全为 $0$，尾数为全为 $0$，即
>  
>  ![Pasted image 20240923170006|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755701542777-ce684310349a48e9baf570caf8a433d6.png)
>  
>  符号位为 $1$ 表示为 $-0$；符号位为 $0$ 表示为 $0$
>  

> [!tip] IEEE 754 binary 格式表示的 $\pm \infty$
> 
> 指数为全为 $1$，尾数位全为 $0$
> 
> ![Pasted image 20240923170317|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755701550681-61e5bfbedf61472b87087962e3ff907d.png)
> 
> 符号位为 $1$ 表示为 $-\infty$；符号位为 $0$ 表示为 $+\infty$
> 

> [!tip] IEEE 754 binary 格式的 NaN
> 
> 指数全为 $1$，尾数不全为 $0$ 
> 
> ![Pasted image 20240923170704|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755701562148-2d27aaea3b54425796a4430cb07c2c16.png)
> 

## 浮点值计算

> [!tip] 规约数
> 
> IEEE 754 binary 表示中，指数位为 $[000\cdots 0001, 111\cdots,1110]$
> 
> ![Pasted image 20240923183024|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755701572961-afabaa2d8fdb412aa43a045ee47a7cda.png)
> 
> 以 binary32 表示的位模式 $[b_{31}, \Vert b_{30}, \cdots, b_{23}\Vert,  b_{22},\cdots,b_2,b_1,b_0]$。其中 $b_{31}$ 表示符号位，$b_{30} \sim b_{22}$ 表示指数位，$b_{22} \sim b_{0}$ 表示尾数位。因此，该位模式在 IEEE 754 binary32 编码下的值为
> $$
> (-1)^{b_{31}} \times 2^{(b_{30}b_{29}\cdots b_{23})_2 - 127} \times (1.b_{22}b_{21}\cdots b_{2}b_{1}b_{0})_2
>$$
>

> [!tip] 非规约数：**用于表示绝对值非常接近于 $0$ 的数**
> 
> IEEE 754 binary 表示中，**指数位全为 $0$**，尾数位非零，那么这个浮点数将被称为**非规约形式的浮点数** 
> 
> ![Pasted image 20240923183223|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755701580421-5e30c283865a442e93f959aa3726df5a.png)
>  
>  IEEE 754标准规定：**非规约形式的浮点数的指数偏移值比规约形式的浮点数的指数偏移值小 1**
>  
>  最小的规约形式的单精度浮点数的指数部分编码值为 $1$，指数的实际值为 $-126$；而**非规约的单精度浮点数的指数域编码值为 $0$，对应的指数实际值也是 $-126$ 而不是 $-127$**
>  
> 以 binary32 表示的位模式 $[b_{31}, \Vert 0_{30}, \cdots, 0_{23}\Vert,  0_{22},\cdots,b_2,b_1,b_0]$
> 
> $$
> (-1)^{b_{31}} \times 2^{-126} \times (0.b_{22}b_{21}\cdots b_{2}b_{1}b_{0})_2
> $$
>

## 范围

对于 **规约数**，取 **最大正值** 时，符号位为 $0$，指数位为 $111....110$，尾数位全为 $1$；取 **最小正值** 时，符号位 $0$，指数位为 $000....0001$，尾数位全为 $0$ 

![Pasted image 20240923190519|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755701587411-b15da3c539364222afc459d09fa073f2.png)

| 类别     | binary32                                                                                                                           | binary64                                                                                                                              |
| :----- | :--------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------ |
| 最小规约正值 | $\begin{aligned}&(-1)^{0}\times 2^{-126} \times 1.000...000\\ &\approx  2^{-126} \\ &\approx 1.17549\times 10^{-38} \end{aligned}$ | $\begin{aligned}&(-1)^{0}\times 2^{-1022} \times 1.000...000\\ &\approx  2^{-1022} \\ &\approx 2.22507\times 10^{-308} \end{aligned}$ |
|        |                                                                                                                                    |                                                                                                                                       |
| 最大规约值  | $\begin{aligned} &(-1)^{0} \times 2^{127} \times 1.111...111\\&\approx  2^{128}\\ &\approx 3.40282 \times 10^{38}\end{aligned}$    | $\begin{aligned} &(-1)^{0} \times 2^{1023} \times 1.111...111\\&\approx  2^{1024}\\ &\approx 1.79769 \times 10^{308}\end{aligned}$    |

对于 **非规约数**，取最大正值时，符号位为 $0$，指数位全为 $0$，尾数位全为 $1$；取最小正值时，符号位为 $0$，指数位全为 $0$，尾数位为 $000....0001$

![Pasted image 20240923191116|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755701603135-5dd89c38eb0d470ea20d6f176aebd402.png)


| 类别      | binary32                                                                                                                                              | binary64                                                                                                                                               |
| :------ | :---------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------- |
| 最小非规约正值 | $\begin{aligned}&(-1)^{0}\times 2^{-126} \times 0.000...001\\ &\approx  2^{-126} \times 2^{-23} \\ &\approx 1.40130\times 10^{-45} \end{aligned}$     | $\begin{aligned}&(-1)^{0}\times 2^{-1022} \times 0.000...001\\ &\approx  2^{-1022} \times 2^{-52} \\ &\approx 4.49066\times 10^{-324} \end{aligned}$   |
|         |                                                                                                                                                       |                                                                                                                                                        |
| 最大非规约值  | $\begin{aligned} &(-1)^{0} \times 2^{-126} \times 0.111...111\\&\approx  2^{-126} \times (1-2^{-23})\\ &\approx 1.17549 \times 10^{-38}\end{aligned}$ | $\begin{aligned} &(-1)^{0} \times 2^{-1022} \times 0.111...111\\&\approx  2^{-1022}\times(1-2^{-52})\\ &\approx 2.22507 \times 10^{-308}\end{aligned}$ |
## 舍入

因为表示方法 **限制浮点数的范围和精度**，所以浮点数运算 **只能近似的表示实数运算**

对于值 $x$ ，我们一般想用一种系统的方法，找到 **最接近的** 匹配值 $x^{\prime}$ , 它可以用期望的浮点形式表示出来，这就是 **舍入** 的运算任务

下面关键任务就是确定 **在两个可能值的中间确定舍入方向**。我们可以确定可表示的值 $x^{-}$ 和 $x^{+}$ 使得 $x^{-} \le x \le x^{+}$  . IEEE 浮点格式定义了四种不同的舍入方式。默认方法是找到 **最接近的匹配** , 而其他三种可用于计算上界和下界

> [!tip] **向偶数舍入**（也称 向最接近值舍入）
>  它将数字向上或者向下舍入，使得 结果的最低有效数字是偶数。（四舍六入五凑偶）

> [!tip] **向零舍入**
> 
> 正数向下舍入，负数向上舍入，得到 $\hat{x}$ , 使得 $|\hat{x}| \le |x|$
> 

> [!tip] **向下舍入**
> 
> 把正数和负数都向下舍入，得到值 $x^{-}$ 使得 $x^{-} \le x$
> 

> [!tip] **向上舍入**
> 
> 把正数和负数都向上舍入，得到值 $x^{+}$ 使得 $x \le x^{+}$
> 


> [!summary] GRS舍入规则
> 
> 执行创建一个浮点数时，如果如果尾数不能完全存储在规定的位上，就需要进行舍入
> 
> ![Pasted image 20241005181343|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755704662273-c95f8cdfba3b404bb617574c1d05ccdd.png)
> 
> + `Guard bit` 是最后一个保留的位
> + `Round bit` 是要丢弃的第一个位
> + `Sticky bit` 是要丢弃的第一个位之后所有位的或
> 
> **如何判断是否进位？**：只需要判断 `r & (g | s) == 0x1` 是否成立；成立则需要进位，否则就舍弃
> 
> ![Pasted image 20241005181448|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755704662273-72c914c1ec044a4e8f19693ff65451d4.png)

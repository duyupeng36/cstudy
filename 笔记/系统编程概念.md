# 系统编程概念

操作系统的核心是 **内核** 通常 **指管理和分配计算机资源的核心层软件**

![Pasted image 20241009214334|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755788707050-54cffe4c7d43405a87b2941b29cf1620.png)

> [!tip] 内核的主要职责
> 
> + 进程管理：进程的创建，调度，销毁
> + 内存管理：进程之间以公平高效的方式共享内存资源
> + 存储管理：文件的管理
> + 联网：内核以用户进程的名义收发网络数据
> + 系统调用：用户进程请求内核执行任务
> 

## 内核的执行

现代操作系统是以 **中断驱动** 的。如果没有进程需要执行，没有 IO 设备需要服务，而且没有用户需要响应，那么操作系统会默默等待某个 **事件** 的发生

> [!tip] 事件
> 
> 事件总是由 **中断** 或 **陷阱** 引起的
> 
> + 陷阱也称异常，是一种有软件中断，或者源于出错，或者用户程序的特定请求
> 
> 对于每种中断，操作系统调用不同处理程序
> 

现代操作系统和用户共享计算机系统的硬件和软件，需要确保用户程序的出错不会影响到操作系统

### 执行模式

为了保证内核的正确运行，必须区分用户代码和内核代码。大多数计算机采用硬件支持，以便区分各种执行模式。至少需要两种单独的执行模式：**用户模式** 和 **内核模式**

> [!tip] 
> 
> 内核模式也称为监视模式或特权模式
> 

计算机硬件通过 **模式位** 表示当前模式

> [!tip] 模式位
> 
> 内核模式：此时，模式位为 $0$
> 
> 用户模式：此时，模式位为 $1$
> 

下图展示了用户模式到内核模式的切换

![Pasted image 20241009220107|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755788707050-fcf7d2e8e9a64a1e9a50cef5d3fa82d1.png)


当系统引导时，硬件从内核模式开始。操作系统开始加载，然后开始在用户模式下执行用户程序。一旦发生中断或异常，硬件会从用户模式切换到内核模式

> [!tip]
> 每当操作系统能够控制计算机时，它就处于内核模式
> 
> 在将控制权交给用户程序前，系统会切换到用户模式
> 

## 使用内核


用户程序请求内核完成任务的方式有三种：或者 **通过 shell**，或者 通过 **库函数**，或者通过 **内核提供的系统调用**

![Pasted image 20241009220946|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755788707055-bc9a4d5d331d4cb095fd6b162785976c.png)

> [!tip] 
> 
> Unix/Linux 系统调用的设计遵循 POSIX 标准 和 System V 标准
> 
> 库函数遵循 ISO C 标准
> 

我们使用内核提供的系统调用进行编程，称为系统编程

## man 手册

man 手册是 Unix/Linux 系统的帮助文档。任何有关系统操作都应该首先查看 man 手册。man 手册总分为 $9$ 个章节

![Pasted image 20241010120517|600](http://cdn.jsdelivr.net/gh/duyupeng36/images@master/obsidian/1755788707055-93080622b64348a490eb38757c887cae.png)

> [!tip] 
> 
> 后续学习主要参考 $2, 3, 7$ 号章节中的内容
> 
> + $2$ 号手册是系统调用接口
> + $3$ 号手册是库函数
> + $7$ 号手册是一些背景知识
> 

man 手册对每个函数的描述都分为 $4$ 段：名字 -> 声明 -> 细节 -> 返回值。阅读函数手册，我们应该首先看 **名字**(包括函数名字和简短描述)；然后，再看 **声明和返回值**(函数需要的参数和返回的内容)；最后，看函数的 **细节描述**(按需查看)

> [!tip] 参数
> 
> 系统调用接口的参数如果是指针类型，需要注意区分 `const` 指针和非 `const` 指针
> + `const` 指针表明函数不会修改指针指向的内存
> + 非 `const` 指针表明函数会修改指针指向的内存。用作 **传出参数**，即函数向调用者返回值
> 

> [!tip] 返回值
> 
> 如果系统调用或库函数返回一个指针，那么该指针一定不是指向栈区中的内存；而或者位于 **堆**，或 **数据段** 区域
> 
> 在 Linux 系统调用中，大多数返回值可以用于函数的错误信息
> 
